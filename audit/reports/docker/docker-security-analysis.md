# üê≥ –û—Ç—á–µ—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–î–∞—Ç–∞**: 2025-09-06  
**–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–µ —Ñ–∞–π–ª—ã**: Dockerfile –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö  

## üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

### 1. –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ USER –≤ Dockerfile

**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ—Ç root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å–µ—Ä–≤–∏—Å—ã**:
- auth-svc
- album-svc  
- analytics-svc
- api-gateway
- billing-svc
- media-svc
- moderation-svc
- notification-svc
- print-svc
- qr-svc
- scan-gateway
- user-profile-svc

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ Dockerfile**:
```dockerfile
FROM python:3.12-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app ./app

ENV PYTHONUNBUFFERED=1

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**–†–∏—Å–∫–∏**:
- –ü–æ–≤—ã—à–µ–Ω–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—É –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

#### ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ pin'–∞ –≤–µ—Ä—Å–∏–π –ø–∞–∫–µ—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –í requirements.txt –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã —Ç–æ—á–Ω—ã–µ –≤–µ—Ä—Å–∏–∏

**–ü—Ä–∏–º–µ—Ä**:
```txt
fastapi
uvicorn
sqlalchemy
```

**–†–∏—Å–∫–∏**:
- –ù–µ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–µ —Å–±–æ—Ä–∫–∏
- –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ breaking changes

#### ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `--no-cache` –¥–ª—è apt-get

**–†–∏—Å–∫–∏**:
- –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ –∫—ç—à–µ

### 2. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

#### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π Dockerfile (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)

```dockerfile
FROM python:3.12-slim

# –°–æ–∑–¥–∞–µ–º non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN groupadd -r appuser && useradd -r -g appuser appuser

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY app ./app

# –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤
RUN chown -R appuser:appuser /app

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER appuser

ENV PYTHONUNBUFFERED=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π requirements.txt

```txt
# –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
alembic==1.12.1
pydantic==2.5.0
```

### 3. Docker Compose –ø—Ä–æ–±–ª–µ–º—ã

#### ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ resource limits

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ —É–∫–∞–∑–∞–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
```yaml
services:
  auth-svc:
    # ... existing config ...
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    ulimits:
      nofile:
        soft: 1024
        hard: 2048
```

#### ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ health checks

**–ü—Ä–æ–±–ª–µ–º–∞**: Health checks –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
```yaml
services:
  auth-svc:
    # ... existing config ...
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

### 4. –°–µ–∫—Ä–µ—Ç—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### ‚ùå –°–µ–∫—Ä–µ—Ç—ã –≤ docker-compose.yml

**–ü—Ä–æ–±–ª–µ–º—ã**:
- JWT —Å–µ–∫—Ä–µ—Ç –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω
- –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è RabbitMQ –∏ MinIO

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
```yaml
services:
  auth-svc:
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
```

### 5. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

#### üîç Trivy (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Trivy:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Trivy
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh

# –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤
trivy image qr_album-auth-svc:latest
trivy image qr_album-api-gateway:latest
```

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º

| –°–µ—Ä–≤–∏—Å | USER | Resource Limits | Health Check | –°–µ–∫—Ä–µ—Ç—ã | –°—Ç–∞—Ç—É—Å |
|--------|------|-----------------|--------------|---------|--------|
| auth-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| album-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| analytics-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| api-gateway | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| billing-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| media-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| moderation-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| notification-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| print-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| qr-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| scan-gateway | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| user-profile-svc | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å**: ‚ùå **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. **–î–æ–±–∞–≤–∏—Ç—å USER** –≤–æ –≤—Å–µ Dockerfile
2. **–í—ã–Ω–µ—Å—Ç–∏ —Å–µ–∫—Ä–µ—Ç—ã** –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. **–î–æ–±–∞–≤–∏—Ç—å health checks** –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å resource limits** –≤ docker-compose
2. **–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏–∏** –≤ requirements.txt
3. **–î–æ–±–∞–≤–∏—Ç—å ulimits** –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∏** Docker –æ–±—Ä–∞–∑–æ–≤
2. **–î–æ–±–∞–≤–∏—Ç—å multi-stage builds** –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ CI/CD

## üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
docker-compose build --no-cache

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–æ–≤
docker images | grep qr_album

# –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (–ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Trivy)
trivy image qr_album-auth-svc:latest
```
