# üîß –û—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–∞–≥–∞ billing-svc (#audit-006)

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2025-01-27  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°—Ä–µ–¥–Ω–∏–π  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è  

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–í TODO.md –±—ã–ª–∞ —É–∫–∞–∑–∞–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: "–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤ (–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å Pydantic)". –ü–æ—Å–ª–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—ã—è–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π `None` –∑–Ω–∞—á–µ–Ω–∏–π –≤ –º–µ—Ç–æ–¥–µ `check_limits` –∫–ª–∞—Å—Å–∞ `UsageService`.

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö**

**–§–∞–π–ª**: `apps/billing-svc/app/services/usage_service.py`  
**–°—Ç—Ä–æ–∫–∏**: 259-283  

**–ü—Ä–æ–±–ª–µ–º–∞**: 
```python
# –ü–†–û–ë–õ–ï–ú–ù–´–ô –ö–û–î
if albums_count is not None and plan.max_albums is not None:
    current_albums = (current_usage.albums_count if current_usage else 0) + albums_count
```

**–ê–Ω–∞–ª–∏–∑**:
- –ï—Å–ª–∏ `current_usage.albums_count` —Ä–∞–≤–Ω–æ `None` (—á—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ –≤ SQLAlchemy)
- –¢–æ –ø–æ–ª—É—á–∏—Ç—Å—è `None + albums_count`, —á—Ç–æ –≤—ã–∑–æ–≤–µ—Ç `TypeError`
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π: `pages_count`, `media_files_count`, `qr_codes_count`, `storage_used_mb`

### 2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è Pydantic**

**–§–∞–π–ª**: `apps/billing-svc/app/routes/usage.py`  
**–°—Ç—Ä–æ–∫–∏**: 36-42  

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.

## üîß –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ None –∑–Ω–∞—á–µ–Ω–∏–π

**–§–∞–π–ª**: `apps/billing-svc/app/services/usage_service.py`

**–î–æ**:
```python
if albums_count is not None and plan.max_albums is not None:
    current_albums = (current_usage.albums_count if current_usage else 0) + albums_count
    if current_albums > plan.max_albums:
        limits_exceeded.append(f"–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∞–ª—å–±–æ–º–æ–≤: {current_albums}/{plan.max_albums}")
```

**–ü–æ—Å–ª–µ**:
```python
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç None)
current_albums_count = (current_usage.albums_count or 0) if current_usage else 0
current_pages_count = (current_usage.pages_count or 0) if current_usage else 0
current_media_count = (current_usage.media_files_count or 0) if current_usage else 0
current_qr_count = (current_usage.qr_codes_count or 0) if current_usage else 0
current_storage_mb = (current_usage.storage_used_mb or 0) if current_usage else 0

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
if albums_count is not None and plan.max_albums is not None:
    total_albums = current_albums_count + albums_count
    if total_albums > plan.max_albums:
        limits_exceeded.append(f"–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∞–ª—å–±–æ–º–æ–≤: {total_albums}/{plan.max_albums}")
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è Pydantic

**–§–∞–π–ª**: `apps/billing-svc/app/routes/usage.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
```python
from pydantic import BaseModel, Field, validator

class CheckLimitsRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤."""
    albums_count: Optional[int] = Field(None, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ª—å–±–æ–º–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
    pages_count: Optional[int] = Field(None, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
    media_files_count: Optional[int] = Field(None, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
    qr_codes_count: Optional[int] = Field(None, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ QR –∫–æ–¥–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
    storage_used_mb: Optional[int] = Field(None, ge=0, description="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ú–ë –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
    
    @validator('*', pre=True)
    def validate_positive_values(cls, v):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π."""
        if v is not None and v < 0:
            raise ValueError('–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º')
        return v
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª**: `apps/billing-svc/tests/test_usage_service.py`

–°–æ–∑–¥–∞–Ω—ã comprehensive unit —Ç–µ—Å—Ç—ã:

1. **test_check_limits_with_none_current_usage** - —Ç–µ—Å—Ç –∫–æ–≥–¥–∞ `current_usage = None`
2. **test_check_limits_with_none_values_in_usage** - —Ç–µ—Å—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—è —Å–æ–¥–µ—Ä–∂–∞—Ç `None`
3. **test_check_limits_exceeded_with_none_values** - —Ç–µ—Å—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ —Å `None`
4. **test_check_limits_no_subscription** - —Ç–µ—Å—Ç –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
5. **test_check_limits_no_plan** - —Ç–µ—Å—Ç –±–µ–∑ –ø–ª–∞–Ω–∞
6. **test_valid_positive_values** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
7. **test_valid_none_values** - –≤–∞–ª–∏–¥–∞—Ü–∏—è `None` –∑–Ω–∞—á–µ–Ω–∏–π
8. **test_valid_zero_values** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
9. **test_invalid_negative_values** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
10. **test_mixed_valid_values** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–º–µ—à–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **None –∑–Ω–∞—á–µ–Ω–∏—è –≤ current_usage**:
   ```python
   current_usage.albums_count = None
   albums_count = 5
   # –†–µ–∑—É–ª—å—Ç–∞—Ç: 0 + 5 = 5 (–±–µ–∑ –æ—à–∏–±–∫–∏)
   ```

2. **–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
   ```python
   request = CheckLimitsRequest(albums_count=-1)
   # –†–µ–∑—É–ª—å—Ç–∞—Ç: ValidationError
   ```

3. **–°–º–µ—à–∞–Ω–Ω—ã–µ None –∏ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
   ```python
   request = CheckLimitsRequest(
       albums_count=None,
       pages_count=10,
       media_files_count=None
   )
   # –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
   ```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- ‚úÖ –í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ `None` –∑–Ω–∞—á–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è Pydantic –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- ‚úÖ –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

## üìä –í–ª–∏—è–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå –í–æ–∑–º–æ–∂–Ω—ã–µ `TypeError` –ø—Ä–∏ `None + —á–∏—Å–ª–æ`
- ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ unit —Ç–µ—Å—Ç–æ–≤

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `None` –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è Pydantic
- ‚úÖ Comprehensive unit —Ç–µ—Å—Ç—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ None –∑–Ω–∞—á–µ–Ω–∏–π** –≤ –º–µ—Ç–æ–¥–µ `check_limits`
- [x] **–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è Pydantic** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- [x] **–°–æ–∑–¥–∞–Ω—ã unit —Ç–µ—Å—Ç—ã** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [x] **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö** –ø—Ä–∏ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞
- [x] **–ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω** –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `apps/billing-svc/app/services/usage_service.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
- `apps/billing-svc/app/routes/usage.py` - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è Pydantic
- `apps/billing-svc/tests/test_usage_service.py` - unit —Ç–µ—Å—Ç—ã
- `audit/BILLING_SVC_ANALYSIS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ production
3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –æ–±–Ω–æ–≤–∏—Ç—å API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

**‚úÖ –ë–ê–ì –ò–°–ü–†–ê–í–õ–ï–ù –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù**

–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤ –≤ billing-svc –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞. –ö–æ–¥ —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `None` –∑–Ω–∞—á–µ–Ω–∏—è –∏ –∏–º–µ–µ—Ç —Å—Ç—Ä–æ–≥—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
